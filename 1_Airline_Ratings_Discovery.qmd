---
title: "Airline_Ratings"
format: revealjs
editor: visual
author: Shuchao Cui
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = FALSE)
# renv::snapshot()
install.packages(c("tidyverse","ggplot2","dplyr","GGally","gapminder","png","sf","maps","rnaturalearth","ggthemes","vcd","psych","corrplot","tm","wordcloud"))
library(tidyverse)
library(dplyr)
library(ggplot2)
library(GGally)
library(gapminder)
library(png)
library(GGally)
library(sf)
library(maps)
library(rnaturalearth)
library(ggthemes)
library(vcd)
library(psych)
library(corrplot)
library(tm)
library(wordcloud)

# renv::restore()
# renv::hydrate()
```

```{r}
# options(error = NULL) 
ratings_raw <- read.csv("data/Airline_Reviews.csv")
#price <- read.csv("data/Flight_Price.csv")

```

```{r}
theme_set(theme_bw(base_size = 12))
```

## Glimpse of data

Datasets on Kaggle, from <https://www.airlinequality.com/>

The second dataset about "price" was verified invalid in the analysis procedure

```{r}
glimpse(ratings_raw)
#glimpse(price)
```

## Discovery 1.1 Distribution over Time

The data lasts to Feb 2023

```{r}
# Modify date column
ratings <- ratings_raw |> 
  separate(DatePub," ",into=c("Date","Month","Year")) |> 
  rename("CabinServiceRating" = "ServiceRating",
         "ValueforMoneyRating" = "ValueRating") |> 
  na.omit()

# Distribution over time  
ratings |> 
  ggplot() +
  aes(y=Year) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si()) +
  labs(x="n_samples",y="year")
```

## Discovery 1.2 Distribution over CabinType

```{r}
# Distribution over CabinType
ratings |>
  ggplot() +
  aes(y=fct_infreq(CabinType)) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si())
```

## Discovery 1.2 Rating Trend over CabinType

```{r}
ratings |> 
  filter(Year >= 2013) |> 
  group_by(Year,CabinType) |> 
  summarise(avg_score=mean(OverallScore,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=CabinType) +
  geom_line(aes(group=CabinType)) +
  geom_point(size=2)
```

## Discovery 1.3 Distribution over TravelType

```{r}
# Distribution over Travel Type
ratings |>
  ggplot() +
  aes(y=fct_infreq(TravelType)) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si())
```

## Discovery 1.3 Rating Trend over TravelType

```{r}
ratings |> 
  filter(Year >= 2013) |> 
  group_by(Year,TravelType) |> 
  summarise(avg_score=mean(OverallScore,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=TravelType) +
  geom_line(aes(group=TravelType)) +
  geom_point(size=2)
```

## Discovery 1.4 Distribution over Departure Continent

```{r}
# Distribution on continent. Discover in a fast way with â€œgapminder".
gapminder <- gapminder |> 
  mutate(country_fixed = str_replace_all(country,"\\s","")) #eliminate spaces

left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  ggplot() +
  aes(y=fct_infreq(continent)) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si()) +
  labs(y="Departure",x="",subtitle="clean and join the country column with third-party dataset")
```

## Discovery 1.4 Rating Trend over Departure Continent

```{r}
left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  filter(Year >= 2013) |> 
  group_by(Year,continent) |> 
  summarise(avg_score=mean(OverallScore,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=continent) +
  geom_line(aes(group=continent)) +
  geom_point(size=2) +
  labs(color="departure")
```

## Discovery 1.5 Distribution over European Countries

```{r}
# Explore further in Europe
left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  filter(continent=="Europe") |> 
  ggplot() +
  aes(y=fct_infreq(OriginCountry)) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si()) +
  labs(x="",y="departure")
```

## Discovery 1.5 Rating Trend over European Countries

```{r}
left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  filter(continent=="Europe") |> 
  filter(Year >= 2013) |> 
  filter(OriginCountry %in% c("UnitedKingdom","Germany","Netherlands","France","Switzerland","Italy","Spain"
                              # ,"Ireland","Belgium","Sweden","Greece","Austria","Denmark"
                              )) |> 
  group_by(Year,OriginCountry) |> 
  summarise(avg_score=mean(OverallScore,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=OriginCountry) +
  geom_line(aes(group=OriginCountry)) +
  geom_point(size=2) +
  labs(color="departure")
```

## Discovery 1.6 Distribution over Asian Countries

```{r}
# Look deeper in Asia
left_join(ratings,distinct(select(gapminder,country,continent)),join_by(OriginCountry==country)) |>
  filter(continent=="Asia") |> 
  ggplot() +
  aes(y=fct_infreq(OriginCountry)) +
  geom_bar() +
  scale_x_continuous(labels=scales::label_number_si())
```

## Discovery 1.6 Rating Trend over Asian Countries

```{r}
left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  filter(continent=="Asia") |> 
  filter(Year >= 2013) |> 
  filter(OriginCountry %in% c("India","Singapore","Thailand","China","Indonesia","Malaysia","Philippines"
                              # ,"Japan","Israel","Vienam","Taiwan","Kuwait","Pakistan"
                              )) |> 
  group_by(Year,OriginCountry) |> 
  summarise(avg_score=mean(OverallScore,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=OriginCountry) +
  geom_line(aes(group=OriginCountry)) +
  geom_point(size=2) +
  labs(color="departure")
```

## Discovery 1.6 Rating of different Services

Departure from China

```{r}
left_join(ratings,distinct(select(gapminder,country_fixed,continent)),join_by(OriginCountry==country_fixed)) |>
  filter(OriginCountry=="China") |> 
  filter(Year >= 2013) |> 
  pivot_longer(cols = contains("Rating"),
               names_to = "service_type",
               values_to = "Rating",
               names_pattern = "(.*)Rating") |>
  group_by(Year,service_type) |> 
  summarise(avg_score=mean(Rating,na.rm=TRUE)) |> 
  na.omit() |> 
  ggplot() +
  aes(x=Year,y=avg_score,color=service_type) +
  geom_line(aes(group=service_type)) +
  geom_point(size=2)
```
